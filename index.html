<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŽ® Forca Online Multiplayer</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // ====== FIREBASE ======
  const firebaseConfig = {
    apiKey: "AIzaSyBdxd54oFM3eWH1duC5BTdJzjGGRDLMq-Q",
    authDomain: "mary-cb817.firebaseapp.com",
    databaseURL: "https://mary-cb817-default-rtdb.firebaseio.com",
    projectId: "mary-cb817",
    storageBucket: "mary-cb817.firebasestorage.app",
    messagingSenderId: "887348832569",
    appId: "1:887348832569:web:c6d9c32a1a1c402b8960e8",
    measurementId: "G-86HWEH554E"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ====== VARIÃVEIS ======
  let playerName = '';
  let playerRole = ''; // "player1" ou "player2"
  let roomId = '';
  let currentWord = '';
  let displayWord = [];
  let errors = 6;
  let wrongLetters = [];
  let audioContext;
  let gameStarted = false;

  // ====== ELEMENTOS HTML ======
  const startDiv = document.getElementById('startDiv');
  const nameInput = document.getElementById('nameInput');
  const roleSelect = document.getElementById('roleSelect');
  const joinBtn = document.getElementById('joinBtn');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const roomInput = document.getElementById('roomInput');

  const player1Div = document.getElementById('player1Div');
  const player2Div = document.getElementById('player2Div');
  const wordInput = document.getElementById('wordInput');
  const wordDisplay = document.getElementById('wordDisplay');
  const errorsLeft = document.getElementById('errorsLeft');
  const wrongLettersEl = document.getElementById('wrongLetters');
  const letterInput = document.getElementById('letterInput');
  const keyboardDiv = document.getElementById('keyboard');
  const bgMusic = document.getElementById('bgMusic');
  const muteBtn = document.getElementById('muteBtn');

  const player1ScoreEl = document.getElementById('player1Score');
  const player2ScoreEl = document.getElementById('player2Score');

  // ====== INICIALIZAÃ‡ÃƒO ======
  window.addEventListener('DOMContentLoaded', () => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    bgMusic.volume = 0.3;
    bgMusic.play().catch(() => {
      document.body.addEventListener('click', () => bgMusic.play(), { once: true });
    });
  });

  window.toggleMute = function() {
    bgMusic.muted = !bgMusic.muted;
    muteBtn.innerHTML = bgMusic.muted ? 'ðŸ”‡' : 'ðŸ”Š';
  }

  // ====== CRIAR OU ENTRAR EM SALA ======
  createRoomBtn.onclick = async () => {
    playerName = nameInput.value.trim();
    playerRole = roleSelect.value;
    if (!playerName || !playerRole) return alert('Digite nome e escolha o papel!');
    
    roomId = push(ref(db, 'rooms')).key;
    await set(ref(db, `rooms/${roomId}`), {
      player1: playerRole==='player1'? playerName : '',
      player2: playerRole==='player2'? playerName : '',
      word: '',
      guesses: {},
      wrongLetters: [],
      errors: 6,
      scores: {player1:0, player2:0}
    });
    enterRoom();
  }

  joinBtn.onclick = async () => {
    playerName = nameInput.value.trim();
    playerRole = roleSelect.value;
    const rId = roomInput.value.trim();
    if(!playerName || !playerRole || !rId) return alert('Digite todos os dados!');
    
    const roomSnap = await get(ref(db, `rooms/${rId}`));
    if(!roomSnap.exists()) return alert('Sala nÃ£o existe!');
    roomId = rId;
    const roomData = roomSnap.val();
    if(playerRole==='player1' && !roomData.player1) await update(ref(db, `rooms/${roomId}`), {player1: playerName});
    if(playerRole==='player2' && !roomData.player2) await update(ref(db, `rooms/${roomId}`), {player2: playerName});
    enterRoom();
  }

  function enterRoom() {
    startDiv.classList.add('hidden');
    if(playerRole==='player1') player1Div.classList.remove('hidden');
    else player2Div.classList.remove('hidden');

    listenRoom();
    createKeyboard();
  }

  // ====== LISTENER DO JOGO ======
  function listenRoom() {
    onValue(ref(db, `rooms/${roomId}`), snapshot => {
      const data = snapshot.val();
      if(!data) return;
      currentWord = data.word || '';
      errors = data.errors ?? 6;
      wrongLetters = data.wrongLetters || [];
      displayWord = currentWord.split('').map(l => data.guesses[l] ? l : '_');

      updateDisplay();
      errorsLeft.textContent = errors;
      wrongLettersEl.textContent = wrongLetters.join(', ') || 'Nenhuma';
      player1ScoreEl.textContent = data.scores.player1 ?? 0;
      player2ScoreEl.textContent = data.scores.player2 ?? 0;

      checkWinLose(data);
    });
  }

  // ====== JOGO ======
  window.submitWord = async () => {
    const word = wordInput.value.trim().toUpperCase();
    if(word.length<3) return alert('Palavra deve ter pelo menos 3 letras');
    await update(ref(db, `rooms/${roomId}`), {word, guesses:{}, errors:6, wrongLetters:[]});
    player1Div.classList.add('hidden');
    player2Div.classList.remove('hidden');
  }

  function createKeyboard() {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    keyboardDiv.innerHTML = '';
    alphabet.forEach(l => {
      const btn = document.createElement('button');
      btn.textContent = l;
      btn.onclick = () => guessLetter(l, btn);
      keyboardDiv.appendChild(btn);
    });
  }

  function guessLetter(letter, btn) {
    if(btn.disabled) return;
    btn.disabled = true;
    btn.classList.add('used');
    setGuess(letter);
  }

  async function setGuess(letter) {
    const roomRef = ref(db, `rooms/${roomId}`);
    const snap = await get(roomRef);
    if(!snap.exists()) return;
    const data = snap.val();
    if(data.guesses[letter]) return;

    const updates = {};
    updates[`guesses/${letter}`] = true;
    await update(roomRef, updates);

    if(!currentWord.includes(letter)){
      const newErrors = (data.errors ?? 6)-1;
      const wrong = [...(data.wrongLetters||[]), letter];
      await update(roomRef, {errors: newErrors, wrongLetters: wrong});
    }
  }

  function updateDisplay() {
    wordDisplay.innerHTML = displayWord.map(l => `<span class="letter-box">${l}</span>`).join('');
  }

  function checkWinLose(data){
    if(displayWord.every(l => l!=='_') && currentWord){
      alert(`Jogador 2 venceu! Palavra: ${currentWord}`);
      const score = data.scores;
      score.player2 +=1;
      resetGame(score);
    } else if(errors<=0){
      alert(`Jogador 1 venceu! Palavra: ${currentWord}`);
      const score = data.scores;
      score.player1 +=1;
      resetGame(score);
    }
  }

  async function resetGame(score){
    await update(ref(db, `rooms/${roomId}`), {word:'', guesses:{}, errors:6, wrongLetters:[], scores: score});
    if(playerRole==='player1') player1Div.classList.remove('hidden');
    else player2Div.classList.add('hidden');
    wordInput.value = '';
    createKeyboard();
  }

</script>

<style>
body { font-family:sans-serif; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; display:flex; flex-direction:column; align-items:center; padding:20px; }
.hidden{display:none;}
.game-card{background:#fff;color:#2d3748;padding:20px;border-radius:15px;margin-top:20px;}
.letter-box{display:inline-block;width:40px;height:50px;border-bottom:3px solid #667eea;margin:0 5px;text-align:center;font-size:28px;}
button{padding:10px 20px;border:none;border-radius:10px;background:#667eea;color:#fff;cursor:pointer;margin-top:10px;}
.keyboard button{margin:5px;}
</style>
</head>
<body>

<audio id="bgMusic" loop autoplay>
  <source src="https://customer-assets.emergentagent.com/job_letra-puzzle/artifacts/oq47urn4_WhatsApp-Video-2026-02-02-at-20.16.54.mp3" type="audio/mpeg">
</audio>
<button id="muteBtn" onclick="toggleMute()">ðŸ”Š</button>

<h1>ðŸŽ® Forca Online Multiplayer</h1>

<div id="startDiv" class="game-card">
  <input type="text" id="nameInput" placeholder="Digite seu nome" />
  <select id="roleSelect">
    <option value="">Escolha papel</option>
    <option value="player1">Jogador 1</option>
    <option value="player2">Jogador 2</option>
  </select>
  <br>
  <button id="createRoomBtn">Criar Sala</button>
  <br>
  <input type="text" id="roomInput" placeholder="CÃ³digo da Sala" />
  <button id="joinBtn">Entrar na Sala</button>
</div>

<div id="player1Div" class="game-card hidden">
  <h2>ðŸ‘¤ Jogador 1: Escolha a Palavra</h2>
  <input type="text" id="wordInput" placeholder="Digite a palavra secreta" />
  <button onclick="submitWord()">ðŸš€ ComeÃ§ar</button>
  <p>PontuaÃ§Ã£o: Jogador 1: <span id="player1Score">0</span> | Jogador 2: <span id="player2Score">0</span></p>
</div>

<div id="player2Div" class="game-card hidden">
  <h2>ðŸŽ¯ Jogador 2: Adivinhe!</h2>
  <div id="wordDisplay"></div>
  <p>Tentativas restantes: <span id="errorsLeft">6</span></p>
  <p>Letras erradas: <span id="wrongLetters">Nenhuma</span></p>
  <div id="keyboard" class="keyboard"></div>
  <input type="text" id="letterInput" maxlength="1" placeholder="Ou digite aqui" />
  <button onclick="setGuess(letterInput.value.toUpperCase())">Tentar</button>
  <p>PontuaÃ§Ã£o: Jogador 1: <span id="player1Score">0</span> | Jogador 2: <span id="player2Score">0</span></p>
</div>

</body>
</html>
